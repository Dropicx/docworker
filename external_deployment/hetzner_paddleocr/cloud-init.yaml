#cloud-config
# ============================================================================
# PP-StructureV3 OCR Server - Cloud Init Script for Hetzner
# ============================================================================
# Use this cloud-init script when creating a Hetzner VM (CPX51 recommended)
# Paste into Hetzner's "Cloud config" field during server creation.
#
# This script:
# - Updates system packages
# - Installs Docker and docker-compose
# - Sets up firewall (SSH + port 9124 only)
# - Creates 8GB swap for model loading
# - Optimizes kernel for ML workloads
# - Pre-creates directory structure and docker-compose file
# ============================================================================

# Update system
package_update: true
package_upgrade: true

# Install packages
packages:
  - docker.io
  - docker-compose
  - git
  - curl
  - htop
  - ufw
  - fail2ban

# Enable Docker
runcmd:
  # Enable Docker service
  - systemctl enable docker
  - systemctl start docker

  # Setup firewall (allow SSH + PP-StructureV3)
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp
  - ufw allow 9124/tcp
  - ufw --force enable

  # Create app directory
  - mkdir -p /opt/paddleocr
  - chown -R root:root /opt/paddleocr

  # Generate secure API key at boot time and save to .env
  - ["sh", "-c", "openssl rand -hex 32 > /tmp/api_key.txt"]
  - ["sh", "-c", "echo 'API_SECRET_KEY='$(cat /tmp/api_key.txt) > /opt/paddleocr/.env"]
  - ["sh", "-c", "echo 'USE_GPU=false' >> /opt/paddleocr/.env"]
  - chmod 600 /opt/paddleocr/.env
  - ["sh", "-c", "cat /tmp/api_key.txt > /opt/paddleocr/API_KEY.txt"]
  - chmod 600 /opt/paddleocr/API_KEY.txt
  - rm -f /tmp/api_key.txt

  # Setup swap (8GB for model loading spikes)
  - fallocate -l 8G /swapfile
  - chmod 600 /swapfile
  - mkswap /swapfile
  - swapon /swapfile
  - ["sh", "-c", "echo '/swapfile none swap sw 0 0' >> /etc/fstab"]

  # Optimize for ML workloads
  - ["sh", "-c", "echo 'vm.swappiness=10' >> /etc/sysctl.conf"]
  - ["sh", "-c", "echo 'vm.vfs_cache_pressure=50' >> /etc/sysctl.conf"]
  - sysctl -p

  # Enable fail2ban for SSH protection
  - systemctl enable fail2ban
  - systemctl start fail2ban

# Write configuration files
write_files:
  # Welcome message
  - path: /etc/motd
    content: |
      =====================================
      PP-StructureV3 OCR Server
      Hetzner CPX51 | 32GB RAM | 16 vCPU

      Service: /opt/paddleocr
      Port: 9124

      Quick commands:
        cd /opt/paddleocr
        ./deploy.sh          # First-time setup
        docker-compose up -d
        docker-compose logs -f
        docker-compose down
      =====================================
    permissions: '0644'

  # Docker Compose file
  - path: /opt/paddleocr/docker-compose.yml
    content: |
      version: '3.8'

      services:
        ppstructure:
          image: ppstructure:cpu
          container_name: ppstructure
          ports:
            - "9124:9124"
          env_file:
            - .env
          environment:
            - PYTHONUNBUFFERED=1
            - PADDLEOCR_DEFAULT_MODE=structured
          volumes:
            - paddle_models:/home/appuser/.paddlex
          restart: unless-stopped
          deploy:
            resources:
              limits:
                memory: 28G
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:9124/health"]
            interval: 30s
            timeout: 10s
            retries: 5
            start_period: 300s

      volumes:
        paddle_models:
    permissions: '0644'

  # Environment example file (template only - real .env is generated at boot)
  - path: /opt/paddleocr/.env.example
    content: |
      # PP-StructureV3 External Service Configuration
      # ========================================
      # The .env file is auto-generated at boot with a secure API key.
      # To regenerate: openssl rand -hex 32

      # API Key for authentication (required for security)
      API_SECRET_KEY=<auto_generated_at_boot>

      # GPU mode (false for CPU, true for GPU)
      USE_GPU=false
    permissions: '0644'

  # Quick deployment script
  - path: /opt/paddleocr/deploy.sh
    content: |
      #!/bin/bash
      set -e

      echo "=========================================="
      echo "PP-StructureV3 Deployment Script"
      echo "=========================================="

      cd /opt/paddleocr

      # Clone or update repo
      REPO_URL="https://github.com/Dropicx/doctranslator.git"
      BRANCH="dev"

      if [ ! -d "doctranslator" ]; then
          echo "üì• Cloning repository..."
          git clone -b $BRANCH $REPO_URL doctranslator
      else
          echo "üì• Updating repository..."
          cd doctranslator && git pull origin $BRANCH && cd ..
      fi

      # Copy paddleocr_service files to /opt/paddleocr
      echo "üìÅ Copying service files..."
      cp -r doctranslator/paddleocr_service/* /opt/paddleocr/

      # Build Docker image (CPU mode)
      echo "üî® Building Docker image (CPU mode)..."
      echo "   This will take 5-10 minutes on first build..."
      docker build --build-arg USE_GPU=false -t ppstructure:cpu .

      # Stop old container if running
      docker-compose down 2>/dev/null || true

      # Start service
      echo "üöÄ Starting service..."
      docker-compose up -d

      echo ""
      echo "‚è≥ Waiting for PP-StructureV3 to start..."
      echo "   (First startup downloads ~2GB of models)"

      for i in {1..30}; do
          if curl -sf http://localhost:9124/health > /dev/null 2>&1; then
              echo ""
              echo "‚úÖ Service is healthy!"
              curl -s http://localhost:9124/health | python3 -m json.tool 2>/dev/null || curl -s http://localhost:9124/health
              break
          fi
          echo "   Waiting... ($i/30)"
          sleep 10
      done

      # Final check
      if ! curl -sf http://localhost:9124/health > /dev/null 2>&1; then
          echo "‚ö†Ô∏è  Service not responding yet. Check logs:"
          echo "   docker-compose logs -f"
          exit 1
      fi

      echo ""
      echo "=========================================="
      echo "‚úÖ Deployment complete!"
      echo "=========================================="
      echo ""
      echo "üìã Add these to your backend environment:"
      echo ""
      echo "   EXTERNAL_OCR_URL=http://$(curl -s ifconfig.me):9124"
      echo "   EXTERNAL_API_KEY=$(cat /opt/paddleocr/API_KEY.txt)"
      echo "   USE_EXTERNAL_OCR=true"
      echo ""
      echo "üìä Useful commands:"
      echo "   View logs:  docker-compose logs -f"
      echo "   Restart:    docker-compose restart"
      echo "   Stop:       docker-compose down"
      echo "   Update:     ./deploy.sh"
    permissions: '0755'

# Final message
final_message: |
  =====================================
  PP-StructureV3 VM Ready!

  SSH: ssh root@<your_ip>

  Your API key was auto-generated at boot.
  View it with: cat /opt/paddleocr/API_KEY.txt

  Next steps:
  1. SSH into the server
  2. Run: cd /opt/paddleocr && ./deploy.sh
  3. Add env vars to your backend
  =====================================
